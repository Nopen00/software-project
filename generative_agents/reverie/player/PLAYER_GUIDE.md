# 플레이어 추가 기초 가이드

## 작업 개요

- **구동 구조 파악**  
  `reverie/backend_server` 내 시뮬레이션 루프, 엔티티 로딩, 상태 업데이트가 어떻게 동작하는지 확인합니다. 특히 `persona/prompt_template/run_gpt_prompt.py` 에서 스케줄·틱 처리 부분을 분석하면 전체 흐름 파악에 도움이 됩니다.
- **엔티티 계층 확장**  
  기존 NPC가 어떤 클래스로 정의되는지 확인한 뒤, 동일한 베이스를 활용하거나 조합하여 `Player` 엔티티를 설계합니다. 위치, 인벤토리, 입력 큐 등 플레이어 전용 상태를 정의하세요.
- **스케줄러 연동**  
  시뮬레이션 틱에서 플레이어가 행동을 실행할 타이밍을 정의합니다. 입력 큐가 비었을 때는 대기하고, 명령이 도착하면 곧바로 처리하는 로직을 추가합니다.
- **행동 정의**  
  이동, 물체 조작, 대화, 놀래키기 등 필요한 액션을 명시적으로 모델링합니다. 각 액션의 월드 영향(타일 점유, 인벤토리 갱신, NPC 상태 변화 등)을 구현하고 이벤트를 발행하여 NPC가 반응할 수 있도록 합니다.
- **상호작용 파이프라인**  
  플레이어 행동이 NPC 의사결정에 들어갈 수 있는 이벤트 버퍼/큐를 설계합니다. NPC가 이벤트를 읽고 우선순위나 상태를 갱신하도록 규칙을 정의합니다.
- **입력 채널 결정**  
  CLI, REST API, UI 등 플레이어 명령 입력 경로를 선택하고, “명령 → 액션 큐 → 시뮬레이션 루프” 흐름으로 연결될 수 있도록 API/소켓 등을 준비합니다.
- **시각화/로그 보강**  
  플레이어 상태와 이벤트를 쉽게 확인할 수 있도록 로그·디버그 출력·뷰어 등을 보강합니다. NPC 반응 트래킹에 도움이 되도록 주요 이벤트를 기록합니다.
- **테스트 시나리오 작성**  
  플레이어 행동이 기대한 월드 변화와 NPC 반응을 유발하는지 검사하는 자동/반자동 테스트를 준비합니다. 이동, 상호작용 등 핵심 시나리오를 커버하세요.

## 개발 전략

1. **엔트리포인트 조사**  
   `run_gpt_prompt.py` 등 시뮬레이션이 시작되는 지점을 추적하여 엔티티 생성 및 틱 호출 구조를 이해합니다.
2. **Player 구조 초안 작성**  
   `PlayerState`, `PlayerController` 등 기본 클래스를 정의하고, 스케줄러에 등록할 최소 코드를 마련합니다.
3. **기본 액션 검증**  
   이동 또는 관측 같은 간단한 액션을 먼저 구현해 이벤트가 정상 발행·처리되는지 확인합니다.
4. **상호작용 확장**  
   물건 이동, 대화, 놀래키기 등의 액션을 점진적으로 추가하면서 NPC 반응 규칙을 조정합니다.

## 독립 모듈 설계 방법

- **모듈 구조**  
  `reverie/player/` 디렉터리를 활용해 상태, 행동, 입력 처리를 별도 파일로 구성합니다. 실제 시뮬레이션과 연결되는 부분은 인터페이스/추상 메서드로 분리해 두세요.
- **월드 인터페이스 추상화**  
  위치 조회, NPC 목록, 이벤트 발행 등을 담당할 `WorldGateway` 인터페이스를 정의하고, 현재는 더미 구현(`MockWorldGateway`)으로 테스트를 진행합니다.
- **행동 로직 분리**  
  각 액션은 월드 인터페이스 호출에만 의존하도록 설계하여 테스트와 유지보수를 용이하게 합니다.
- **이벤트 설계**  
  플레이어 행동 후 NPC에게 전달할 이벤트 구조를 미리 정의해 두고, 나중에 실제 이벤트 버스와 연결할 수 있도록 준비합니다.
- **테스트 더블**  
  격자 지도와 몇 개의 더미 NPC를 가진 간단한 월드를 만들어 플레이어 모듈을 독립적으로 실행·검증합니다.
- **통합 준비**  
  시뮬레이션 복구 후 필요한 훅(플레이어 등록, 이벤트 주입, 틱 콜백 등)을 명시해 두면, 구현체만 교체하여 바로 연결할 수 있습니다.

## 현재 구현된 스켈레톤

- `interface.py`: 월드 접근을 위한 `WorldGateway`, 이벤트 프로토콜 정의
- `actions.py`: 액션 컨텍스트, 기본 프로토콜, `MoveAction` 구현
- `controller.py`: `PlayerState`, 큐 기반 `PlayerController`
- `mock_world.py`: 단위 테스트용 `MockWorldGateway`, `SimpleEvent`
- `__init__.py`: 외부에서 사용할 핵심 API 재노출

이 구조를 바탕으로 추가 액션(`PickUpItem`, `TalkToNpc`, `ScareNpc` 등)과 테스트 코드를 작성해 두면, 시뮬레이션이 복구된 뒤 빠르게 통합할 수 있습니다.

